<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>BingMap影像</title>
    <link href="./Cesium/Widgets/widgets.css" rel="stylesheet">
    <link href="./css/pretty.css" rel="stylesheet">
    <script src="./js/jquery.min.js"></script>
    <script src="./js/config.js"></script>
    <script src="./js/mapConfig.js"></script>
    <script src="./Cesium/Cesium.js"></script>
    <script src="./js/KMap3D.js"></script>
    <script type="text/javascript" src="./js/require.min.js" data-main="js/main"></script>
</head>
<body>
<div id="cesiumContainer"></div>
<div id='loadingbar' class="spinner">
    <div class="spinner-container container1">
        <div class="circle1"></div>
        <div class="circle2"></div>
        <div class="circle3"></div>
        <div class="circle4"></div>
    </div>
    <div class="spinner-container container2">
        <div class="circle1"></div>
        <div class="circle2"></div>
        <div class="circle3"></div>
        <div class="circle4"></div>
    </div>
    <div class="spinner-container container3">
        <div class="circle1"></div>
        <div class="circle2"></div>
        <div class="circle3"></div>
        <div class="circle4"></div>
    </div>
</div>
<script>
    function onload() {

        // 初始化kmap
        let kmap = new KMap3D('cesiumContainer');
        let viewer = kmap.map.kmapViewer;
        let scene = viewer.scene;

        // viewer.imageryLayers.addImageryProvider(new Cesium.SingleTileImageryProvider({
        //     url: './images/BlackMarble_2016.jpg'
        // }));

        let city = scene.primitives.add(
            new Cesium.Cesium3DTileset({
                url: 'http://data.marsgis.cn/3dtiles/jzw-shanghai/tileset.json'
            })
        );
        // city.style = new Cesium.Cesium3DTileStyle({
        //     color: "color('grey')",
        //     show: true
        // });
        city.readyPromise.then(function(tileset) {
            console.log('scene.layers', scene);
            viewer.camera.setView({
                destination:Cesium.Cartesian3.fromDegrees(121.466139,31.257341,2170.8),
                orientation: {
                    heading: Cesium.Math.toRadians(122.2),
                    pitch: Cesium.Math.toRadians(-31.8),
                    roll: Cesium.Math.toRadians(0.2),
                },
            })
        });

        // 已选择的信息
        let selected = {
            feature: undefined,
            originalColor: new Cesium.Color()
        };

        if (Cesium.PostProcessStageLibrary.isSilhouetteSupported(viewer.scene)) {
            let silhouetteBlue = Cesium.PostProcessStageLibrary.createEdgeDetectionStage();
            silhouetteBlue.uniforms.color = Cesium.Color.WHITE;
            silhouetteBlue.uniforms.length = 0.01;
            silhouetteBlue.selected = [];

            viewer.scene.postProcessStages.add(Cesium.PostProcessStageLibrary.createSilhouetteStage([silhouetteBlue]));
            viewer.screenSpaceEventHandler.setInputAction(function onMouseMove(movement) {
                silhouetteBlue.selected = [];
                let pickedFeature = viewer.scene.pick(movement.endPosition);
                if (!Cesium.defined(pickedFeature)) {
                    return;
                }
                if (pickedFeature !== selected.feature) {
                    silhouetteBlue.selected = [pickedFeature];
                }
            }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);
        }

        // 交互事件
        // let handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
        // let previousPickedEntity = undefined;
        // handler.setInputAction(function(e) {
        //     let pickedEntity = viewer.scene.pick(e.position);
        //     console.log('pickedEntity', pickedEntity);
        //     pickedEntity.getPropertyNames().forEach(propetry => {
        //         console.log(propetry + ':' + pickedEntity.getProperty(propetry));
        //     });
        //     // 取消上一次的高亮效果
        //     if (Cesium.defined(previousPickedEntity)) {
        //         previousPickedEntity.color = Cesium.Color.GREY;
        //     }

        //     if (Cesium.defined(pickedEntity) && Cesium.defined(pickedEntity.color)) {
        //         pickedEntity.color = Cesium.Color.WHITE;
        //         previousPickedEntity = pickedEntity;
        //     }

        // }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
        

        $('#loadingbar').remove();
    }
</script>
</body>
</html>
